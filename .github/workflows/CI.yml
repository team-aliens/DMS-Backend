name: CI with Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [main, notification, gateway]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests for ${{ matrix.service }} service
        run: |
          if [ "${{ matrix.service }}" = "main" ]; then
            ./gradlew :dms-main:test jacocoMainServiceReport --info
          elif [ "${{ matrix.service }}" = "notification" ]; then
            ./gradlew :dms-notification:test jacocoNotificationServiceReport --info
          elif [ "${{ matrix.service }}" = "gateway" ]; then
            ./gradlew :dms-gateway:test jacocoGatewayServiceReport --info
          fi

      - name: Upload coverage for ${{ matrix.service }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/reports/jacoco/${{ matrix.service }}-service/jacocoTestReport.xml
          flags: ${{ matrix.service }}-service
          name: ${{ matrix.service }}-service-coverage
          fail_ci_if_error: false
          verbose: true

  test-all:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run all tests
        run: ./gradlew test --info

      - name: Generate service-specific coverage reports
        run: ./gradlew jacocoAllServiceReports --info

      - name: Verify Jacoco reports exist
        run: |
          echo "=== Looking for service-specific Jacoco reports ==="
          echo "=== Main service report ==="
          ls -la build/reports/jacoco/main-service/ || echo "No main service report found"
          echo "=== Notification service report ==="
          ls -la build/reports/jacoco/notification-service/ || echo "No notification service report found"
          echo "=== Gateway service report ==="
          ls -la build/reports/jacoco/gateway-service/ || echo "No gateway service report found"

      - name: Comment PR with main service coverage
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: |
            build/reports/jacoco/main-service/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 70
          min-coverage-changed-files: 80
          title: 'ðŸ“Š Main Service Coverage Report'

      - name: Comment PR with notification service coverage
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: |
            build/reports/jacoco/notification-service/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 70
          min-coverage-changed-files: 80
          title: 'ðŸ“Š Notification Service Coverage Report'

      - name: Comment PR with gateway service coverage
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: |
            build/reports/jacoco/gateway-service/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 70
          min-coverage-changed-files: 80
          title: 'ðŸ“Š Gateway Service Coverage Report'
